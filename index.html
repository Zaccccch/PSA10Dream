<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PSA10Dream - ä¿®å¤å¢å¼ºç‰ˆ</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
    <style>
        :root { --bg: #202225; --sidebar: #2f3136; --text: #ffffff; --accent: #007bff; --success: #28a745; }
        * { touch-action: manipulation; box-sizing: border-box; }
        body { margin: 0; display: flex; height: 100vh; background-color: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; overflow: hidden; }

        /* å“åº”å¼å¸ƒå±€æ§åˆ¶ */
        #container { display: flex; width: 100%; height: 100%; flex-direction: row; }
        @media (max-width: 768px) {
            #container { flex-direction: column; }
            #sidebar { width: 100% !important; height: auto !important; max-height: 45vh; overflow-y: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
            #main { height: 55vh !important; }
        }

        /* ä¾§è¾¹æ æ ·å¼æ¢å¤ */
        #sidebar { width: 300px; background: var(--sidebar); padding: 20px; z-index: 10; display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.3); }
        .section { margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        h3 { font-size: 13px; margin: 0 0 10px 0; color: #8e9297; text-transform: uppercase; }
        
        button { width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 5px; background: #4f545c; color: white; cursor: pointer; font-weight: bold; font-size: 14px; }
        button:hover { background: #686d73; }
        button.primary { background: var(--accent); }
        button.save { background: var(--success); }

        /* çŠ¶æ€æŒ‡ç¤ºç¯ */
        #status-container { display: flex; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .light { width: 12px; height: 12px; border-radius: 50%; background-color: #ff4d4d; margin-right: 10px; }
        .light.ready { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }

        /* ä½¿ç”¨è¯´æ˜ */
        .instruction-box { margin-top: auto; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; font-size: 12px; border-left: 4px solid var(--accent); }
        
        /* ä¸»ç”»å¸ƒåŒº */
        #main { flex: 1; display: flex; justify-content: center; align-items: center; background: #0f1012; position: relative; }
        canvas { max-width: 100%; max-height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.5); cursor: crosshair; touch-action: none; }
    </style>
</head>
<body>

<div id="container">
    <div id="sidebar">
        <div id="status-container">
            <div id="status-light" class="light"></div>
            <span id="status-text">æ£€æŸ¥ OpenCV è¿æ¥...</span>
        </div>

        <div class="section">
            <h3>1. åŸå§‹å›¾åƒ</h3>
            <input type="file" id="fileInput" accept="image/*" style="display:none">
            <button class="primary" onclick="handleOpenImage()">æ‰“å¼€æœ¬åœ°å›¾ç‰‡</button>
            <button onclick="location.reload()">é‡å¯åº”ç”¨</button>
        </div>

        <div class="section">
            <h3>2. çŸ«æ­£ä¸æµ‹é‡</h3>
            <button class="primary" onclick="doRectify()">æ‰§è¡Œé€è§†çŸ«æ­£</button>
            <button onclick="enterStage2()">é‡é€‰æµ‹é‡è¾¹ç•Œ</button>
            <button class="save" onclick="saveImageWithDialog()">å¦å­˜ä¸ºç»“æœå›¾</button>
        </div>

        <div class="instruction-box">
            <strong>ğŸ’¡ æ“ä½œæŒ‡å—ï¼š</strong><br>
            1. å¾…ç¯å˜ç»¿ï¼Œç‚¹å·¦ä¸Šè§’å››ä¸ªè§’ã€‚<br>
            2. çŸ«æ­£åç‚¹4ä¸‹åˆ’å®šå†…æ¡†ã€‚<br>
            3. <b>æ‹–åŠ¨é»„çº¿</b>å¯å®æ—¶è§‚å¯Ÿå³ä¸Šè§’åƒç´ æ•°å€¼ã€‚
        </div>
    </div>

    <div id="main">
        <canvas id="canvas"></canvas>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let imgOrig = null, matOrig = null, matRectified = null;
    let stage = 1, points1 = [], points2 = [], isCollecting2 = false, lines = null, dragging = null;
    let isCvLoaded = false;

    // OpenCV åˆå§‹åŒ–
    var Module = {
        onRuntimeInitialized: () => {
            isCvLoaded = true;
            document.getElementById('status-light').className = 'light ready';
            document.getElementById('status-text').innerText = 'OpenCV å·²å°±ç»ª';
        }
    };

    function handleOpenImage() {
        if (!isCvLoaded) return alert("è¯·ç­‰å¾… OpenCV åŠ è½½å®Œæˆ...");
        document.getElementById('fileInput').click();
    }

    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            imgOrig = new Image();
            imgOrig.onload = () => {
                canvas.width = imgOrig.width;
                canvas.height = imgOrig.height;
                if (matOrig) matOrig.delete();
                matOrig = cv.imread(imgOrig);
                stage = 1; points1 = []; points2 = []; lines = null;
                redraw();
            };
            imgOrig.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    // ç»Ÿä¸€ç‚¹å‡»/è§¦æ‘¸åæ ‡è½¬æ¢
    function getEventPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: (clientX - rect.left) * (canvas.width / rect.width),
            y: (clientY - rect.top) * (canvas.height / rect.height)
        };
    }

    const startEvent = 'ontouchstart' in window ? 'touchstart' : 'mousedown';
    canvas.addEventListener(startEvent, (e) => {
        const pos = getEventPos(e);
        if (stage === 1 && points1.length < 4) {
            points1.push(pos);
        } else if (stage === 2) {
            if (isCollecting2) {
                points2.push(pos);
                if (points2.length === 4) {
                    lines = { 
                        left: Math.min(...points2.map(p=>p.x)), 
                        right: Math.max(...points2.map(p=>p.x)), 
                        top: Math.min(...points2.map(p=>p.y)), 
                        bottom: Math.max(...points2.map(p=>p.y)) 
                    };
                    isCollecting2 = false;
                }
            } else if (lines) {
                const tol = 30; // åˆ¤å®šèŒƒå›´
                if (Math.abs(pos.x - lines.left) < tol) dragging = 'left';
                else if (Math.abs(pos.x - lines.right) < tol) dragging = 'right';
                else if (Math.abs(pos.y - lines.top) < tol) dragging = 'top';
                else if (Math.abs(pos.y - lines.bottom) < tol) dragging = 'bottom';
            }
        }
        redraw();
    });

    window.addEventListener('mousemove', (e) => {
        if (!dragging || !lines) return;
        lines[dragging] = getEventPos(e)[dragging.includes('left') || dragging.includes('right') ? 'x' : 'y'];
        redraw();
    });
    window.addEventListener('touchmove', (e) => {
        if (!dragging || !lines) return;
        const pos = getEventPos(e);
        lines[dragging] = (dragging==='left'||dragging==='right') ? pos.x : pos.y;
        redraw();
    }, {passive: false});

    window.addEventListener('mouseup', () => dragging = null);
    window.addEventListener('touchend', () => dragging = null);

    function doRectify() {
        if (points1.length !== 4) return alert("è¯·å…ˆç‚¹é€‰ 4 ä¸ªè§’ç‚¹");
        let srcPts = cv.matFromArray(4, 1, cv.CV_32FC2, points1.flatMap(p => [p.x, p.y]));
        const [p1, p2, p3, p4] = points1;
        const w = Math.max(Math.hypot(p2.x-p1.x, p2.y-p1.y), Math.hypot(p3.x-p4.x, p3.y-p4.y));
        const h = Math.max(Math.hypot(p4.x-p1.x, p4.y-p1.y), Math.hypot(p3.x-p2.x, p3.y-p2.y));
        let dstPts = cv.matFromArray(4, 1, cv.CV_32FC2, [0, 0, w, 0, w, h, 0, h]);
        let M = cv.getPerspectiveTransform(srcPts, dstPts);
        if (matRectified) matRectified.delete();
        matRectified = new cv.Mat();
        cv.warpPerspective(matOrig, matRectified, M, new cv.Size(w, h));
        canvas.width = w; canvas.height = h;
        stage = 2; isCollecting2 = true; points2 = []; lines = null;
        redraw();
        srcPts.delete(); dstPts.delete(); M.delete();
    }

    function redraw() {
        if (stage === 1 && matOrig) { cv.imshow(canvas, matOrig); drawOverlay1(); }
        else if (stage === 2 && matRectified) { cv.imshow(canvas, matRectified); drawOverlay2(); }
    }

    function drawOverlay1() {
        ctx.fillStyle = "#00ff00"; ctx.strokeStyle = "#ffff00"; ctx.lineWidth = 3;
        points1.forEach((p, i) => {
            ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill();
            ctx.font = "bold 20px Arial"; ctx.fillText(i+1, p.x+15, p.y-15);
        });
    }

    function drawOverlay2() {
        if (isCollecting2) {
            ctx.fillStyle = "#00ff00";
            points2.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill(); });
        } else if (lines) {
            ctx.strokeStyle = "#ffff00"; ctx.lineWidth = 2;
            // ç”»åå­—çº¿
            ctx.beginPath(); ctx.moveTo(lines.left, 0); ctx.lineTo(lines.left, canvas.height); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(lines.right, 0); ctx.lineTo(lines.right, canvas.height); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, lines.top); ctx.lineTo(canvas.width, lines.top); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, lines.bottom); ctx.lineTo(canvas.width, lines.bottom); ctx.stroke();
            
            // --- å…³é”®ï¼šæ‰¾å›æ•°å€¼é¢æ¿ ---
            ctx.fillStyle = "rgba(0,0,0,0.8)";
            ctx.fillRect(canvas.width - 170, 10, 160, 100);
            ctx.fillStyle = "white";
            ctx.font = "14px Arial";
            ctx.fillText(`L (å·¦): ${lines.left.toFixed(1)}px`, canvas.width - 150, 35);
            ctx.fillText(`R (å³): ${(canvas.width - lines.right).toFixed(1)}px`, canvas.width - 150, 55);
            ctx.fillText(`T (ä¸Š): ${lines.top.toFixed(1)}px`, canvas.width - 150, 75);
            ctx.fillText(`B (ä¸‹): ${(canvas.height - lines.bottom).toFixed(1)}px`, canvas.width - 150, 95);
        }
    }

    function enterStage2() { isCollecting2 = true; points2 = []; redraw(); }

    async function saveImageWithDialog() {
        const fileName = window.prompt("è¯·è¾“å…¥æ–‡ä»¶å:", `PSA_Check_${Date.now()}`);
        if (!fileName) return;
        const link = document.createElement('a');
        link.download = fileName + ".png";
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
</body>
</html>
