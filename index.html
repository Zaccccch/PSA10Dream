<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PSA10Dream - 智能加载版</title>
    <style>
        :root { --panel-bg: #222; --accent: #007bff; --green: #28a745; }
        * { touch-action: none; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; color: white; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* 引导弹窗 */
        #guide-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #333; padding: 25px; border-radius: 15px; width: 100%; max-width: 320px; border: 1px solid #555; }
        #close-guide { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 15px; cursor: pointer; }

        /* 上方菜单区 */
        #top-menu { background: var(--panel-bg); padding: 10px; transition: transform 0.3s ease; z-index: 100; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        #top-menu.collapsed { transform: translateY(-100%); position: absolute; width: 100%; }
        
        .status-bar { display: flex; align-items: center; justify-content: center; font-size: 11px; margin-bottom: 8px; gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ff4d4d; }
        .dot.ready { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        /* 5按钮布局 */
        .btn-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 6px; }
        .btn-row.bottom { grid-template-columns: repeat(2, 1fr); }
        button { border: none; border-radius: 6px; padding: 10px 2px; font-size: 12px; color: white; background: #444; font-weight: bold; cursor: pointer; }
        button.primary { background: var(--accent); }
        button.success { background: var(--green); }

        /* 收放手柄 */
        #handle { position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); background: var(--panel-bg); width: 60px; height: 24px; border-radius: 0 0 30px 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .arrow { width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 7px solid #888; transition: 0.3s; }
        #top-menu.collapsed .arrow { transform: rotate(180deg); }

        /* 画布区 - 关键自适应 */
        #view { flex: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 5px; }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; background: #111; }

        #stats { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); padding: 8px; border-radius: 6px; font-size: 11px; pointer-events: none; display: none; border: 1px solid #444; }
    </style>
</head>
<body>

<div id="guide-modal">
    <div class="modal-box">
        <h3 style="margin:0 0 15px 0; color:var(--accent)">使用说明</h3>
        <p style="font-size:13px; color:#ccc">1. 等待指示灯变绿<br>2. 选点 -> 矫正 -> 测距<br>3. 菜单可点击下方箭头收起</p>
        <button id="close-guide">开始使用</button>
    </div>
</div>

<div id="top-menu">
    <div class="status-bar">
        <div id="indicator" class="dot"></div>
        <span id="status-msg">正在链接官方库...</span>
    </div>
    <div class="btn-row">
        <button class="primary" onclick="openFile()">打开图片</button>
        <button onclick="undo()">撤销选点</button>
        <button onclick="location.reload()">重启</button>
    </div>
    <div class="btn-row bottom">
        <button class="primary" id="btn-rect" onclick="doRect()">执行矫正</button>
        <button class="success" id="btn-save" style="display:none" onclick="save()">保存图像</button>
        <button id="btn-rem" style="display:none" onclick="reMeasure()">重选内框</button>
    </div>
    <div id="handle" onclick="toggleMenu()"><div class="arrow"></div></div>
</div>

<div id="view">
    <div id="stats">
        L: <span id="v-l">0</span> | R: <span id="v-r">0</span><br>
        T: <span id="v-t">0</span> | B: <span id="v-b">0</span>
    </div>
    <canvas id="canvas"></canvas>
</div>

<input type="file" id="fIn" accept="image/*" style="display:none">

<script>
    // --- OpenCV 加载逻辑 ---
    let ready = false;
    const OFFICIAL_URL = "https://docs.opencv.org/4.x/opencv.js";
    const MIRROR_URL = "https://cdnjs.cloudflare.com/ajax/libs/opencv.js/4.5.5/opencv.js";

    function loadOpenCV(url) {
        const script = document.createElement('script');
        script.src = url;
        script.async = true;
        script.onerror = () => { if(url === OFFICIAL_URL) fallback(); };
        document.body.appendChild(script);
    }

    const loadTimer = setTimeout(fallback, 10000); // 10秒超时

    function fallback() {
        if (ready) return;
        console.log("官方源超时，正在切换至镜像源...");
        document.getElementById('status-msg').innerText = "切换至镜像加速器...";
        loadOpenCV(MIRROR_URL);
    }

    var Module = { onRuntimeInitialized: () => {
        clearTimeout(loadTimer);
        ready = true;
        document.getElementById('indicator').className = 'dot ready';
        document.getElementById('status-msg').innerText = 'OpenCV 已就绪';
    }};

    loadOpenCV(OFFICIAL_URL);

    // --- 核心业务逻辑 ---
    const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');
    let rawImg = null, matSrc = null, matDst = null;
    let s = 1, pts1 = [], pts2 = [], isM = false, lines = null, drag = null;

    document.getElementById('close-guide').onclick = () => document.getElementById('guide-modal').style.display='none';
    function toggleMenu() { document.getElementById('top-menu').classList.toggle('collapsed'); }

    function openFile() { if(ready) document.getElementById('fIn').click(); else alert("请稍候，引擎正在加载..."); }

    document.getElementById('fIn').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            rawImg = new Image();
            rawImg.onload = () => {
                cvs.width = rawImg.width; cvs.height = rawImg.height;
                if(matSrc) matSrc.delete();
                matSrc = cv.imread(rawImg);
                s = 1; pts1 = []; pts2 = []; lines = null;
                render();
            };
            rawImg.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    function getP(e) {
        const r = cvs.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return {
            x: (t.clientX - r.left) * (cvs.width / r.width),
            y: (t.clientY - r.top) * (cvs.height / r.height)
        };
    }

    const handleInput = (e) => {
        if(!rawImg) return;
        const p = getP(e);
        if(s === 1 && pts1.length < 4) { pts1.push(p); } 
        else if(s === 2) {
            if(isM) {
                pts2.push(p);
                if(pts2.length === 4) {
                    lines = { left: Math.min(...pts2.map(i=>i.x)), right: Math.max(...pts2.map(i=>i.x)), top: Math.min(...pts2.map(i=>i.y)), bottom: Math.max(...pts2.map(i=>i.y)) };
                    isM = false;
                    document.getElementById('stats').style.display = 'block';
                }
            } else if(lines) {
                const tol = 40 * (cvs.width / cvs.clientWidth); // 动态触控容差
                if(Math.abs(p.x - lines.left) < tol) drag = 'left';
                else if(Math.abs(p.x - lines.right) < tol) drag = 'right';
                else if(Math.abs(p.y - lines.top) < tol) drag = 'top';
                else if(Math.abs(p.y - lines.bottom) < tol) drag = 'bottom';
            }
        }
        render();
    };

    cvs.addEventListener('mousedown', handleInput);
    cvs.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});

    const handleMove = (e) => {
        if(!drag) return;
        const p = getP(e);
        if(drag==='left'||drag==='right') lines[drag] = p.x;
        else lines[drag] = p.y;
        render();
    };
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e.touches[0]); }, {passive: false});
    window.addEventListener('mouseup', () => drag = null);
    window.addEventListener('touchend', () => drag = null);

    function doRect() {
        if(pts1.length<4) return alert("请先点选4个角点");
        let srcM = cv.matFromArray(4, 1, cv.CV_32FC2, pts1.flatMap(p => [p.x, p.y]));
        const w = Math.max(Math.hypot(pts1[1].x-pts1[0].x, pts1[1].y-pts1[0].y), Math.hypot(pts1[2].x-pts1[3].x, pts1[2].y-pts1[3].y));
        const h = Math.max(Math.hypot(pts1[3].x-pts1[0].x, pts1[3].y-pts1[0].y), Math.hypot(pts1[2].x-pts1[1].x, pts1[2].y-pts1[1].y));
        let dstM = cv.matFromArray(4, 1, cv.CV_32FC2, [0,0, w,0, w,h, 0,h]);
        let M = cv.getPerspectiveTransform(srcM, dstM);
        if(matDst) matDst.delete();
        matDst = new cv.Mat();
        cv.warpPerspective(matSrc, matDst, M, new cv.Size(w, h));
        cvs.width = w; cvs.height = h;
        s = 2; isM = true; pts2 = []; lines = null;
        document.getElementById('btn-rect').style.display = 'none';
        document.getElementById('btn-save').style.display = 'inline-block';
        document.getElementById('btn-rem').style.display = 'inline-block';
        render();
        srcM.delete(); dstM.delete(); M.delete();
    }

    function render() {
        if(!rawImg) return;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        if(s===1) { cv.imshow(cvs, matSrc); d1(); }
        else { cv.imshow(cvs, matDst); d2(); }
    }

    function d1() {
        ctx.fillStyle = "#00ff00";
        pts1.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, cvs.width/60, 0, Math.PI*2); ctx.fill(); });
    }

    function d2() {
        if(isM) {
            ctx.fillStyle = "#00ff00";
            pts2.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, cvs.width/80, 0, Math.PI*2); ctx.fill(); });
        } else if(lines) {
            ctx.strokeStyle = "#ffff00"; ctx.lineWidth = cvs.width/150;
            const drawL = (x1,y1,x2,y2) => { ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); };
            drawL(lines.left, 0, lines.left, cvs.height); drawL(lines.right, 0, lines.right, cvs.height);
            drawL(0, lines.top, cvs.width, lines.top); drawL(0, lines.bottom, cvs.width, lines.bottom);
            document.getElementById('v-l').innerText = lines.left.toFixed(1);
            document.getElementById('v-r').innerText = (cvs.width - lines.right).toFixed(1);
            document.getElementById('v-t').innerText = lines.top.toFixed(1);
            document.getElementById('v-b').innerText = (cvs.height - lines.bottom).toFixed(1);
        }
    }

    function undo() { if(s===1) pts1.pop(); else pts2.pop(); render(); }
    function reMeasure() { isM = true; pts2 = []; lines = null; document.getElementById('stats').style.display = 'none'; render(); }
    function save() { const a = document.createElement('a'); a.download = 'psa_check.png'; a.href = cvs.toDataURL(); a.click(); }
</script>
</body>
</html>
