<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PSA10Dream - 最终适配版</title>
    <style>
        :root { --bg: #000; --panel: #1a1a1a; --accent: #007bff; }
        * { box-sizing: border-box; touch-action: none; }
        
        /* 使用 dvh 确保在手机浏览器中动态适配高度 */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100dvh; 
            overflow: hidden; background: var(--bg); color: white; 
            display: flex; flex-direction: column; font-family: sans-serif;
        }

        /* 顶部菜单：增加 padding 避开手机状态栏 */
        #top-menu { 
            background: var(--panel); 
            padding: calc(10px + env(safe-area-inset-top)) 10px 10px 10px; 
            flex-shrink: 0; 
            border-bottom: 1px solid #333; 
            z-index: 100;
        }
        
        .status-bar { display: flex; align-items: center; justify-content: center; font-size: 12px; margin-bottom: 10px; gap: 6px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #ff4d4d; }
        .dot.ready { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }

        /* 按钮容器：允许换行，确保窄屏下菜单不溢出 */
        .btn-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            justify-content: center; 
        }
        
        button { 
            min-width: 80px;
            flex: 1 1 calc(30% - 10px); /* 手机端每行约3个按钮 */
            border: none; border-radius: 6px; padding: 12px 5px; 
            font-size: 13px; color: white; background: #333; 
            font-weight: bold; cursor: pointer; 
        }
        button.primary { background: var(--accent); }
        button.success { background: #28a745; }

        /* 图片显示区：占据除去菜单后的所有空间 */
        #view { 
            flex: 1; 
            width: 100%; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: #000;
            overflow: hidden; 
            padding: 5px; /* 留一点空隙防止贴边 */
        }

        /* 画布：完美适配容器 */
        canvas { 
            max-width: 100%; 
            max-height: 100%; 
            object-fit: contain; 
            display: block;
        }

        #stats { 
            position: absolute; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.8); padding: 5px 8px; 
            border-radius: 4px; font-size: 11px; color: #0f0;
            border: 1px solid #444; pointer-events: none; display: none;
            font-family: monospace; z-index: 50;
        }
    </style>
</head>
<body>

<div id="top-menu">
    <div class="status-bar">
        <div id="indicator" class="dot"></div>
        <span id="status-msg">OpenCV 准备中...</span>
    </div>
    
    <div class="btn-row">
        <button class="primary" id="btn-open" onclick="document.getElementById('fIn').click()">打开图片</button>
        <button id="btn-undo" onclick="undo()">撤销</button>
        <button id="btn-rect" class="primary" style="background:#6610f2" onclick="doRect()">执行矫正</button>
        
        <button class="success" id="btn-save" style="display:none" onclick="saveImg()">另存结果</button>
        <button id="btn-rem" style="display:none" onclick="reMeasure()">重选内框</button>
        <button id="btn-reset" style="display:none" onclick="location.reload()">重启</button>
    </div>
</div>

<div id="view">
    <div id="stats">
        L:<span id="v-l">0</span> R:<span id="v-r">0</span><br>
        T:<span id="v-t">0</span> B:<span id="v-b">0</span>
    </div>
    <canvas id="canvas"></canvas>
</div>

<input type="file" id="fIn" accept="image/*" style="display:none">

<script>
    const cvs = document.getElementById('canvas'), ctx = cvs.getContext('2d');
    let ready = false, rawImg = null, matSrc = null, matDst = null;
    let s = 1, pts1 = [], pts2 = [], isM = false, lines = null, drag = null;

    // --- 加载策略 ---
    const OFF_URL = "https://docs.opencv.org/4.x/opencv.js";
    const MIR_URL = "https://cdnjs.cloudflare.com/ajax/libs/opencv.js/4.5.5/opencv.js";
    const timer = setTimeout(() => { if(!ready) loadCV(MIR_URL); }, 10000);

    function loadCV(url) {
        const script = document.createElement('script'); script.src = url; script.async = true;
        script.onerror = () => { if(url === OFF_URL) loadCV(MIR_URL); };
        document.body.appendChild(script);
    }
    var Module = { onRuntimeInitialized: () => {
        ready = true; clearTimeout(timer);
        document.getElementById('indicator').className = 'dot ready';
        document.getElementById('status-msg').innerText = 'OpenCV 已就绪';
    }};
    loadCV(OFF_URL);

    // --- 逻辑处理 ---
    document.getElementById('fIn').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            rawImg = new Image();
            rawImg.onload = () => {
                cvs.width = rawImg.width; cvs.height = rawImg.height;
                if(matSrc) matSrc.delete();
                matSrc = cv.imread(rawImg);
                s = 1; pts1 = []; pts2 = []; lines = null;
                render();
            };
            rawImg.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    };

    function getP(e) {
        const r = cvs.getBoundingClientRect();
        const t = e.touches ? e.touches[0] : e;
        return {
            x: (t.clientX - r.left) * (cvs.width / r.width),
            y: (t.clientY - r.top) * (cvs.height / r.height)
        };
    }

    const start = (e) => {
        if(!rawImg) return;
        const p = getP(e);
        if(s === 1 && pts1.length < 4) { pts1.push(p); } 
        else if(s === 2) {
            if(isM) {
                pts2.push(p);
                if(pts2.length === 4) {
                    lines = { left: Math.min(...pts2.map(i=>i.x)), right: Math.max(...pts2.map(i=>i.x)), top: Math.min(...pts2.map(i=>i.y)), bottom: Math.max(...pts2.map(i=>i.y)) };
                    isM = false; document.getElementById('stats').style.display = 'block';
                }
            } else if(lines) {
                const tol = 50 * (cvs.width / cvs.clientWidth);
                if(Math.abs(p.x - lines.left) < tol) drag = 'left';
                else if(Math.abs(p.x - lines.right) < tol) drag = 'right';
                else if(Math.abs(p.y - lines.top) < tol) drag = 'top';
                else if(Math.abs(p.y - lines.bottom) < tol) drag = 'bottom';
            }
        }
        render();
    };

    cvs.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); }, {passive: false});
    cvs.addEventListener('mousedown', start);

    const move = (e) => {
        if(!drag) return;
        const p = getP(e.touches ? e.touches[0] : e);
        if(drag==='left'||drag==='right') lines[drag] = p.x; else lines[drag] = p.y;
        render();
    };
    window.addEventListener('touchmove', (e) => { if(drag) e.preventDefault(); move(e); }, {passive: false});
    window.addEventListener('mousemove', move);
    window.addEventListener('touchend', () => drag = null);
    window.addEventListener('mouseup', () => drag = null);

    function doRect() {
        if(pts1.length<4) return alert("请先点选4个角点");
        let srcM = cv.matFromArray(4, 1, cv.CV_32FC2, pts1.flatMap(p => [p.x, p.y]));
        const w = Math.max(Math.hypot(pts1[1].x-pts1[0].x, pts1[1].y-pts1[0].y), Math.hypot(pts1[2].x-pts1[3].x, pts1[2].y-pts1[3].y));
        const h = Math.max(Math.hypot(pts1[3].x-pts1[0].x, pts1[3].y-pts1[0].y), Math.hypot(pts1[2].x-pts1[1].x, pts1[2].y-pts1[1].y));
        let dstM = cv.matFromArray(4, 1, cv.CV_32FC2, [0,0, w,0, w,h, 0,h]);
        let M = cv.getPerspectiveTransform(srcM, dstM);
        if(matDst) matDst.delete(); matDst = new cv.Mat();
        cv.warpPerspective(matSrc, matDst, M, new cv.Size(w, h));
        cvs.width = w; cvs.height = h;
        s = 2; isM = true; pts2 = []; lines = null;
        
        // 动态切换按钮
        document.getElementById('btn-rect').style.display = 'none';
        document.getElementById('btn-undo').style.display = 'none';
        document.getElementById('btn-save').style.display = 'inline-block';
        document.getElementById('btn-rem').style.display = 'inline-block';
        document.getElementById('btn-reset').style.display = 'inline-block';
        
        render(); srcM.delete(); dstM.delete(); M.delete();
    }

    function render() {
        if(!rawImg) return;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        if(s===1) {
            cv.imshow(cvs, matSrc);
            ctx.fillStyle = "#0f0";
            pts1.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, cvs.width/60, 0, Math.PI*2); ctx.fill(); });
        } else {
            cv.imshow(cvs, matDst);
            if(isM) {
                ctx.fillStyle = "#0f0";
                pts2.forEach(p => { ctx.beginPath(); ctx.arc(p.x, p.y, cvs.width/80, 0, Math.PI*2); ctx.fill(); });
            } else if(lines) {
                ctx.strokeStyle = "#ff0"; ctx.lineWidth = cvs.width/150;
                const draw = (x1,y1,x2,y2) => { ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); };
                draw(lines.left, 0, lines.left, cvs.height); draw(lines.right, 0, lines.right, cvs.height);
                draw(0, lines.top, cvs.width, lines.top); draw(0, lines.bottom, cvs.width, lines.bottom);
                
                document.getElementById('v-l').innerText = lines.left.toFixed(1);
                document.getElementById('v-r').innerText = (cvs.width - lines.right).toFixed(1);
                document.getElementById('v-t').innerText = lines.top.toFixed(1);
                document.getElementById('v-b').innerText = (cvs.height - lines.bottom).toFixed(1);
            }
        }
    }

    function undo() { if(s===1) pts1.pop(); else pts2.pop(); render(); }
    function reMeasure() { isM = true; pts2 = []; lines = null; document.getElementById('stats').style.display = 'none'; render(); }
    function saveImg() { const a = document.createElement('a'); a.download = 'psa_check.png'; a.href = cvs.toDataURL(); a.click(); }
</script>
</body>
</html>
